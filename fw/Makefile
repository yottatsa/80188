sources = reset.S monitor.S

# firmware
fw.bin: $(sources:.S=) 
	dd if=reset of=$@.gen bs=1024 skip=255 seek=255
	dd if=monitor of=$@.gen bs=1024 conv=notrunc
	mv $@.gen $@

# exports symbols as constants
reset.sym: reset
	nasm -DNOMAP -f elf reset.S
	objdump -t reset.o | awk '($$2 == "g"){print $$5}' > reset.glob
	grep -f reset.glob reset.map | \
		awk 'BEGIN{print ";; autogenerated"}{print $$3,"equ","0x"$$1}' > $@

# assembly
%: %.S
	nasm $< -o $@

clean:
	rm -f fw.bin $(sources:.S=.d) $(sources:.S=)

# deps
%.d: %.S
	nasm -M $^ > $@
include $(sources:.S=.d)

.PHONY: clean
